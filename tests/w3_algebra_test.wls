#!/usr/bin/env wolframscript
(* W3 代数测试 - Mathematica 参考实现 *)

(* 设置工作目录并导入 OPEdefs *)
SetDirectory[DirectoryName[$InputFileName]];
SetDirectory[ParentDirectory[]];
SetDirectory["OPEdefs"];
Import["OPEdefs.m"];

(* ============================================================================ *)
(* W3 代数定义 *)
(* ============================================================================ *)

Print["[W3 Algebra Test - Mathematica Reference]"];
Print["=========================================="];
Print[];

(* 声明算符类型 *)
Bosonic[T, W];

(* 定义辅助算符 Λ *)
Λ[w_] := NO[T, T][w] - (3/10) * T''[w];

(* 定义 OPE 规则 *)
Print["定义 W3 代数的 OPE..."];

(* T-T OPE *)
OPE[T, T] := MakeOPE[
    c * One[w] / (2 * (z - w)^4) +
    (2 * T[w]) / (z - w)^2 +
    T'[w] / (z - w) +
    Ord[z, w, 0]
];

(* T-W OPE *)
OPE[T, W] := MakeOPE[
    (3 * W[w]) / (z - w)^2 +
    W'[w] / (z - w) +
    Ord[z, w, 0]
];

(* W-W OPE *)
OPE[W, W] := MakeOPE[
    (c * One[w]) / (z - w)^6 +
    (2 * T[w]) / (z - w)^4 +
    T'[w] / (z - w)^3 +
    (1 / (z - w)^2) * (2 * β * Λ[w] + (3/10) * T''[w]) +
    (1 / (z - w)) * (β * Λ'[w] + (1/15) * T'''[w]) +
    Ord[z, w, 0]
];

Print["OPE 定义完成"];
Print[];

(* ============================================================================ *)
(* Test 1: 基本 OPE 计算 *)
(* ============================================================================ *)

Print["Test 1: T-T OPE"];
Print["================"];
Print["OPE[T, T] = ", OPE[T, T]];
Print[];

Print["Test 2: T-W OPE"];
Print["================"];
Print["OPE[T, W] = ", OPE[T, W]];
Print[];

Print["Test 3: W-W OPE"];
Print["================"];
Print["OPE[W, W] = ", OPE[W, W]];
Print[];

(* ============================================================================ *)
(* Test 4: 导数算符 OPE *)
(* ============================================================================ *)

Print["Test 4: OPE[T, NO[T,T] - (3/10)T'']"];
Print["===================================="];
Print["结果 = ", OPE[T, NO[T, T] - (3/10) * T'']];
Print[];

Print["Test 5: OPE[T, W'']"];
Print["==================="];
Print["结果 = ", OPE[T, W'']];

(* ============================================================================ *)
(* Test 6: 复合正规序 OPE *)
(* ============================================================================ *)

Print["Test 6: NO[T', NO[W'', T]]"];
Print["==========================="];
Print["结果 = ", Expand[NO[T', NO[W'', T]]]];
Print[];

Print["Test 7: NO[W', NO[W'', T]]"];
Print["==========================="];
Print["结果 = ", Expand[NO[W', NO[W'', T]]]];
Print[];

(* ============================================================================ *)
(* Test 8: 数值检验（设定 c=100, β=1/10） *)
(* ============================================================================ *)

Print["Test 8: 数值检验"];
Print["================"];
Print["设置 c=100, β=1/10"];

(* 替换符号参数 *)
Print["OPE[W,W] 数值结果 = ", OPE[W, W] /. {c -> 100, β -> 1/10}];
Print[];

(* ============================================================================ *)
(* 输出结果摘要 *)
(* ============================================================================ *)

Print["测试完成！"];
Print["所有测试结果已输出，可用于对比 Python 实现"];
